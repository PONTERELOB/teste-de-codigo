<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Buffer de KML</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <script src="https://unpkg.com/togeojson@0.16.0/togeojson.js"></script>
  <style>
    body { margin: 0; font-family: sans-serif; }
    #map { height: 100vh; width: 100%; }

    #controls {
      position: absolute;
      top: 10px;
      left: 40px;
      z-index: 1000;
      background: rgba(0, 0, 0, 0.7);
      padding: 12px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.4);
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      max-width: 90%;
      color: white;
    }
    #controls label { margin: 0; white-space: nowrap; }
    input[type="number"], input[type="file"] { width: 120px; }
    button { padding: 1px 12px; cursor: pointer; font-size: 0.9rem; }

    @media (max-width: 600px) {
      #controls { flex-direction: column; align-items: stretch; top: 5px; left: 5px; right: 5px; max-width: none; }
      input[type="number"], input[type="file"], button { width: 100%; }
    }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="kmlFile" accept=".kml" />
    <label>Buffer (m):</label>
    <input type="number" id="bufferDistance" value="0" min="0" step="1" />
    <button onclick="downloadGeoJSON()">Download GeoJSON</button>
    <button onclick="limparTudo()">Limpar Tudo</button>
  </div>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([-19.8, -42.6], 10);

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: '© Esri'
    }).addTo(map);

    let originalFeatures = [];
    let bufferFeatures = [];

    const kmlLayerGroup = L.featureGroup().addTo(map);
    const bufferGroup     = L.featureGroup().addTo(map);

    const fileInput   = document.getElementById('kmlFile');
    const bufferInput = document.getElementById('bufferDistance');

    // Bloqueia abertura do seletor se buffer ≤ 0
    fileInput.addEventListener('click', function(e) {
      const valor = parseFloat(bufferInput.value);
      if (isNaN(valor) || valor <= 0) {
        e.preventDefault();
        alert("Defina um valor MAIOR QUE ZERO no campo Buffer (m) antes de escolher o arquivo KML.");
        bufferInput.focus();
      }
    });

    // Processa o arquivo KML
    fileInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const distancia = parseFloat(bufferInput.value);
      if (distancia <= 0) {
        alert("O valor do buffer deve ser maior que zero.");
        this.value = "";
        return;
      }

      const reader = new FileReader();
      reader.onload = function() {
        const parser = new DOMParser();
        const kml = parser.parseFromString(reader.result, 'text/xml');
        const geojson = toGeoJSON.kml(kml);

        if (!geojson?.features?.length) {
          alert("Erro ao converter KML ou arquivo sem geometria.");
          return;
        }

        originalFeatures = geojson.features;

        // Limpa camadas anteriores
        kmlLayerGroup.clearLayers();
        bufferGroup.clearLayers();

        // Camada original (KML) – linha contínua verde
        L.geoJSON(geojson, {
          style: { 
            color: '#00FF00', 
            weight: 1, 
            fillColor: '#00FF00', 
            fillOpacity: 0.2 
          }
        }).addTo(kmlLayerGroup);

        // Buffer com borda PONTILHADA
        const buffered = turf.buffer(geojson, distancia, { units: 'meters' });
        const features = Array.isArray(buffered.features) ? buffered.features : [buffered];
        bufferFeatures = features.filter(f => f.geometry);

        L.geoJSON({ type: "FeatureCollection", features: bufferFeatures }, {
          style: { 
            color: '#3399ff',
            weight: 2,               // mais grosso para o pontilhado ficar evidente
            opacity: 1,
            fillColor: '#3399ff',
            fillOpacity: 0.15,       // preenchimento bem suave
            dashArray: '12 10',      // borda pontilhada (traço 12px, espaço 10px)
            dashOffset: '0'
          }
        }).addTo(bufferGroup);

        // Ajusta zoom para ver tudo
        map.fitBounds(L.featureGroup([kmlLayerGroup, bufferGroup]).getBounds(), { padding: [50, 50] });
      };

      reader.readAsText(file);
    });

    // Download do GeoJSON (original + buffer)
    function downloadGeoJSON() {
      if (originalFeatures.length === 0) {
        alert("Nenhum dado para exportar.");
        return;
      }
      const data = { 
        type: "FeatureCollection", 
        features: [...originalFeatures, ...bufferFeatures] 
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'kml_com_buffer.geojson';
      a.click();
      URL.revokeObjectURL(url);
    }

    // Limpar tudo
    function limparTudo() {
      kmlLayerGroup.clearLayers();
      bufferGroup.clearLayers();
      originalFeatures = [];
      bufferFeatures = [];
      fileInput.value = "";
      bufferInput.value = "0";
      map.setView([-19.8, -42.6], 10);
    }
  </script>
</body>
</html>